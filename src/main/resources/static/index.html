<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Panel</title>
    <style>
        :root {
            --primary: #007bff;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f8f9fa;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: var(--bg); color: #333; }

        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        h2 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.4rem; }

        .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }

        /* Form Controls */
        .control-group { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }

        label { font-weight: 600; margin-bottom: 5px; display: block; font-size: 0.9rem; }

        input { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; flex: 1; }
        input:focus { border-color: var(--primary); outline: none; }

        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background 0.2s; color: white; }
        button.primary { background-color: var(--primary); }
        button.primary:hover { background-color: #0056b3; }
        button.secondary { background-color: var(--secondary); }
        button.danger { background-color: var(--danger); padding: 5px 10px; font-size: 0.8rem; }
        button.add-btn { background-color: #17a2b8; margin-bottom: 15px; }

        /* Alerts */
        .alert { padding: 15px; border-radius: 4px; margin-top: 15px; display: none; }
        .alert.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Table */
        .table-wrapper { overflow-x: auto; margin-top: 15px; border: 1px solid #dee2e6; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #dee2e6; font-size: 0.95rem; }
        th { background-color: #e9ecef; color: #495057; font-weight: 700; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f1f1f1; }

        .empty-msg { padding: 20px; text-align: center; color: #777; font-style: italic; }
    </style>
</head>
<body>

    <h1>E-Commerce Panel</h1>

    <div class="container">
        <h2>ðŸ“¦ Items Browser</h2>

        <div class="control-group">
            <button class="primary" onclick="getAllItems()">Get All Items</button>
        </div>

        <div class="control-group">
            <input type="number" id="categoryIdInput" placeholder="Category ID">
            <button class="primary" onclick="getItemsByCategory()">Filter by Category</button>
        </div>

        <div class="control-group">
            <input type="number" id="itemIdInput" placeholder="Item ID">
            <button class="primary" onclick="getItemById()">Find by ID</button>
        </div>

        <div id="itemsAlert" class="alert"></div>
        <div id="itemsResult" class="table-wrapper">
            <div class="empty-msg">No data loaded yet.</div>
        </div>
    </div>

    <div class="container">
        <h2>ðŸ›’ Create New Order</h2>

        <div style="margin-bottom: 20px;">
            <label for="clientIdInput">Customer ID:</label>
            <input type="number" id="clientIdInput" placeholder="e.g. 101" min="1">
        </div>

        <label>Order Items:</label>
        <div id="orderItemsContainer">
            </div>

        <button class="secondary add-btn" onclick="addOrderItemRow()">+ Add Item</button>
        <br>
        <button class="primary" style="width: 100%; background-color: var(--success);" onclick="submitOrder()">Submit Order</button>

        <div id="orderAlert" class="alert"></div>
    </div>

    <script>
        const API_URL = "http://localhost:8080";

        // Initialize with one item row
        document.addEventListener("DOMContentLoaded", () => {
            addOrderItemRow();
        });

        // --- HELPER: FORMATTING & ALERTS ---

        function showAlert(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `alert ${type}`;
            el.innerHTML = message;
            el.style.display = 'block';
        }

        function clearAlert(elementId) {
            const el = document.getElementById(elementId);
            el.style.display = 'none';
        }

        /**
         * Converts Objects/Arrays to readable strings for the table.
         * Solves the "Category is JSON" issue.
         */
        function formatValue(val) {
            if (val === null || val === undefined) return "";

            if (typeof val === 'object') {
                if (val.name) return val.name; // Display Category Name if present
                if (val.id) return `ID: ${val.id}`;
                return Object.values(val).join(", ");
            }
            return val;
        }

        // --- ITEMS LOGIC ---

        async function getAllItems() {
            fetchAndRender(`${API_URL}/items`);
        }

        async function getItemsByCategory() {
            const id = document.getElementById('categoryIdInput').value;
            if(!id) return showAlert('itemsAlert', 'error', 'Please enter a Category ID');
            fetchAndRender(`${API_URL}/items?categoryId=${id}`);
        }

        async function getItemById() {
            const id = document.getElementById('itemIdInput').value;
            if(!id) return showAlert('itemsAlert', 'error', 'Please enter an Item ID');
            fetchAndRender(`${API_URL}/items/${id}`, true);
        }

        async function fetchAndRender(url, single = false) {
            const resultEl = document.getElementById('itemsResult');
            clearAlert('itemsAlert');
            resultEl.innerHTML = '<div class="empty-msg">Loading...</div>';

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw await createErrorObject(response);
                }

                const data = await response.json();
                const dataArray = single ? [data] : data;
                renderTable(dataArray, resultEl);

            } catch (err) {
                resultEl.innerHTML = '';
                showAlert('itemsAlert', 'error', `<strong>Error ${err.status || 'Network'}</strong>: ${err.message}`);
            }
        }

        function renderTable(data, container) {
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="empty-msg">No items found.</div>';
                return;
            }

            const headers = Object.keys(data[0]);

            let html = '<table><thead><tr>';
            headers.forEach(h => html += `<th>${h.toUpperCase()}</th>`);
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                headers.forEach(key => {
                    html += `<td>${formatValue(row[key])}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // --- ORDER LOGIC ---

        function addOrderItemRow() {
            const container = document.getElementById('orderItemsContainer');
            const div = document.createElement('div');
            div.className = 'form-row';
            div.innerHTML = `
                <input type="number" class="item-id" placeholder="Item ID" min="1">
                <input type="number" class="item-qty" placeholder="Quantity" min="1" value="1">
                <button class="danger" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(div);
        }

        async function submitOrder() {
            const clientIdVal = document.getElementById('clientIdInput').value;

            // Walidacja wstÄ™pna
            const parsedCustomerId = parseInt(clientIdVal, 10);
            if (!clientIdVal || isNaN(parsedCustomerId) || parsedCustomerId <= 0) {
                showAlert('orderAlert', 'error', 'Customer ID is missing or invalid.');
                return;
            }

            const rows = document.querySelectorAll('#orderItemsContainer .form-row');
            const items = [];

            // Parsowanie wierszy z produktami
            rows.forEach(row => {
                const idStr = row.querySelector('.item-id').value;
                const qtyStr = row.querySelector('.item-qty').value;

                // Konwersja na liczby (Int)
                const id = parseInt(idStr, 10);
                const qty = parseInt(qtyStr, 10);

                // Dodaj tylko jeÅ›li obie wartoÅ›ci sÄ… poprawnymi liczbami (nie NaN)
                if(!isNaN(id) && !isNaN(qty) && id > 0 && qty > 0) {
                    items.push({
                        itemId: id,
                        quantity: qty
                    });
                }
            });

            if (items.length === 0) {
                showAlert('orderAlert', 'error', 'Please add at least one valid item.');
                return;
            }

            // Budowa obiektu
            const orderRequest = {
                customerId: parsedCustomerId,
                items: items
            };

            // DEBUG: Zobacz w konsoli przeglÄ…darki (F12 -> Console) co dokÅ‚adnie leci do backendu
            console.log("Sending payload:", JSON.stringify(orderRequest, null, 2));

            clearAlert('orderAlert');
            const btn = document.querySelector('button[onclick="submitOrder()"]');
            const originalText = btn.innerText;
            btn.innerText = "Sending...";
            btn.disabled = true;

            try {
                const response = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderRequest)
                });

                if (!response.ok) {
                    // Przekazanie odpowiedzi do funkcji obsÅ‚ugi bÅ‚Ä™dÃ³w
                    throw await createErrorObject(response);
                }

                const orderId = await response.json();
                showAlert('orderAlert', 'success', `Success! Order created. <strong>Order ID: ${orderId}</strong>`);

                // Reset formularza po sukcesie
                document.getElementById('clientIdInput').value = "";
                document.getElementById('orderItemsContainer').innerHTML = "";
                addOrderItemRow();

            } catch (err) {
                console.error("API Error Details:", err);
                showAlert('orderAlert', 'error', `<strong>Failed (HTTP ${err.status})</strong>: ${err.message}`);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function createErrorObject(response) {
            let msg = response.statusText;
            try {
                // Try to parse backend error message if available
                const errData = await response.json();
                if(errData.message) msg = errData.message;
            } catch(e) {
                const txt = await response.text();
                if(txt) msg = txt;
            }
            return { status: response.status, message: msg };
        }
    </script>
</body>
</html>